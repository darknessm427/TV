<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÃÎ›ÉŒâ‚­á‘Îğ’¡ğ’¡ğŸ—½ğ•‹ğ•</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0a0a">

    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/darknessm427/darknessm427/main/Image/tv.png?raw=true">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --accent-primary: #00ffff; /* Cyan - Default */
            --accent-secondary: #ff00ff; /* Magenta */
            --border-color: rgba(255, 255, 255, 0.15);
            --shadow-color: rgba(0, 255, 255, 0.3);
            --highlight-bg: rgba(0, 255, 255, 0.1);
            --accent-primary-rgb: 0, 255, 255;
            --accent-secondary-rgb: 255, 0, 255;
            --favorite-color: #ffd700;
            --record-color: #dc3545;
        }
        
        body.light-theme {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --accent-primary: #007bff; /* Blue */
            --accent-secondary: #6f42c1; /* Purple */
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow-color: rgba(0, 123, 255, 0.2);
            --highlight-bg: rgba(0, 123, 255, 0.1);
            --accent-primary-rgb: 0, 123, 255;
            --accent-secondary-rgb: 111, 66, 193;
            --favorite-color: #ffc107;
            --record-color: #dc3545;
        }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background-color 0.4s, color 0.4s;
            font-size: 14px;
        }

        .glass-effect {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            transition: all 0.4s ease;
        }
        
        body:not(.light-theme) .glass-effect {
             background-color: rgba(26, 26, 26, 0.7);
             backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
        }
        
        body.light-theme .glass-effect {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .gradient-text {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .channel-card, .recording-card {
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
        }
        .channel-card:hover, .recording-card:hover {
            transform: translateY(-8px) scale(1.03);
            box-shadow: 0 0 25px var(--shadow-color), 0 0 10px var(--shadow-color);
            border-color: var(--accent-primary);
        }
        
        body.light-theme .channel-card:hover, body.light-theme .recording-card:hover {
            box-shadow: 0 8px 25px var(--shadow-color);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--accent-primary); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--accent-secondary); }

        .modal-animation { animation: modalFade 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes modalFade {
            from { opacity: 0; transform: translateY(-20px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .filter-btn.active, #audioOnlyBtn.active {
            background-color: var(--highlight-bg);
            color: var(--accent-primary);
            border-color: var(--accent-primary);
            box-shadow: 0 0 15px var(--shadow-color);
        }

        .neon-button:hover:not(:disabled) {
            background-color: var(--highlight-bg);
            box-shadow: 0 0 15px var(--shadow-color), 0 0 25px var(--shadow-color);
        }
        
        #sideMenu { transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        #sideMenu.open { transform: translateX(0); }
        #menuOverlay { transition: opacity 0.4s ease; }
        #menuOverlay.open { opacity: 1; pointer-events: auto; }

        .favorite-star {
            position: absolute; top: 8px; left: 8px; cursor: pointer; font-size: 1.25rem;
            color: var(--text-secondary); transition: color 0.2s, transform 0.2s;
        }
        .favorite-star:hover { transform: scale(1.2); }
        .favorite-star.favorited { color: var(--favorite-color); text-shadow: 0 0 8px var(--favorite-color); }
        
        .skeleton-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            50% { opacity: .5; }
        }

        #toast {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background-color: var(--bg-secondary); color: var(--text-primary);
            padding: 12px 24px; border-radius: 8px; z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid var(--border-color);
            transition: top 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            display: flex; align-items: center; gap: 10px;
        }
        #toast.show { top: 20px; }
        #toast.success { border-left: 4px solid #28a745; }
        #toast.error { border-left: 4px solid #dc3545; }
        #toast .icon { font-size: 1.2rem; }

        .color-swatch {
            width: 24px; height: 24px; border-radius: 50%; cursor: pointer;
            border: 2px solid transparent; transition: all 0.2s;
        }
        .color-swatch.active { border-color: var(--text-primary); transform: scale(1.2); }
        
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        #install-tooltip-container:hover #install-tooltip {
            opacity: 1; visibility: visible; pointer-events: auto;
        }
        
        #recordBtn {
            color: var(--record-color);
            border-color: var(--record-color);
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            font-size: 0.75rem;
            font-weight: bold;
        }
        #recordBtn.recording {
            animation: pulse-record 1.5s infinite;
        }
        @keyframes pulse-record {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 10px 15px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }

        #playerContainer.audio-mode::before {
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            content: "\f001"; /* fa-music */
            font-size: 6rem;
            color: var(--text-secondary);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.3;
            z-index: 0;
        }
        #playerContainer.audio-mode video {
            visibility: hidden;
        }

        .player-select {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 0.5rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding-right: 1.5rem;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.25em;
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: { extend: { fontFamily: { 'vazirmatn': ['Vazirmatn', 'sans-serif'] } } }
        }
    </script>
</head>
<body class="bg-[var(--bg-primary)] text-[var(--text-primary)]">

    <div id="toast">
        <span class="icon"></span>
        <span class="message"></span>
    </div>

    <nav class="sticky top-0 z-30 py-4 bg-white/5 backdrop-blur-md border-b" style="background-color: rgba(var(--bg-secondary-rgb, 26, 26, 26), 0.7); border-color: var(--border-color);">
        <div class="container mx-auto px-4 relative flex justify-center items-center h-10">
            <div class="absolute right-4 top-1/2 -translate-y-1/2">
                 <button id="openMenuBtn" class="w-10 h-10 flex items-center justify-center rounded-full text-xl neon-button border border-[var(--accent-primary)] text-[var(--accent-primary)] transition-all duration-300">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            <div class="text-center">
                 <h1 class="text-2xl md:text-3xl font-bold cursor-pointer flex items-center justify-center gap-1" onclick="location.href=window.location.pathname">
                    <span class="gradient-text">ÃÎ›ÉŒâ‚­á‘ï¸Îğ’¡ğ’¡</span>
                    <img src="https://raw.githubusercontent.com/darknessm427/darknessm427/main/Image/tv.png?raw=true" alt="TV Icon" class="h-8 w-8">
                    <span class="gradient-text">ğ•‹ğ•</span>
                </h1>
            </div>
            <div class="absolute left-4 top-1/2 -translate-y-1/2">
                <button id="theme-toggle" class="w-10 h-10 flex items-center justify-center rounded-full text-xl neon-button border border-[var(--accent-primary)] text-[var(--accent-primary)] transition-all duration-300">
                </button>
            </div>
        </div>
    </nav>

    <div id="sideMenu" class="fixed top-0 right-0 h-full w-1/2 max-w-[16rem] glass-effect z-50 flex flex-col" style="border-right: none; border-left: 1px solid var(--border-color);">
        <div class="p-4 flex justify-between items-center border-b border-[var(--border-color)]">
            <h2 class="text-base font-bold gradient-text">Ù…Ù†Ùˆ</h2>
            <button id="closeMenuBtn" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-[var(--highlight-bg)] transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="flex-grow overflow-y-auto custom-scrollbar">
            <div class="p-2 border-b border-[var(--border-color)]">
                 <button id="allChannelsBtn" class="w-full flex justify-between items-center px-4 py-3 text-left font-bold hover:bg-[var(--highlight-bg)] transition-colors rounded-lg text-xs">
                    <div class="flex items-center gap-3"><i class="fas fa-globe-europe w-5 text-center" style="color: var(--accent-primary);"></i><span>Ù‡Ù…Ù‡â€ŒÛŒ Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§</span></div>
                    <span class="text-xs font-normal text-gray-400 uppercase" dir="ltr">All</span>
                </button>
                <button id="favoritesBtn" class="w-full flex justify-between items-center px-4 py-3 text-left font-bold hover:bg-[var(--highlight-bg)] transition-colors rounded-lg text-xs">
                    <div class="flex items-center gap-3"><i class="fas fa-star w-5 text-center" style="color: var(--favorite-color);"></i><span>Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</span></div>
                    <span class="text-xs font-normal text-gray-400 uppercase" dir="ltr">Favorites</span>
                </button>
                <button id="recordingsBtn" class="w-full flex justify-between items-center px-4 py-3 text-left font-bold hover:bg-[var(--highlight-bg)] transition-colors rounded-lg text-xs">
                    <div class="flex items-center gap-3"><i class="fas fa-hdd w-5 text-center"></i><span>ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ÛŒ Ø¶Ø¨Ø· Ø´Ø¯Ù‡</span></div>
                    <span class="text-xs font-normal text-gray-400 uppercase" dir="ltr">Recordings</span>
                </button>
            </div>
            <div class="p-2">
                <button id="categoriesAccordionBtn" class="w-full flex justify-between items-center px-4 py-3 text-left font-bold hover:bg-[var(--highlight-bg)] transition-colors rounded-lg text-xs">
                    <div class="flex items-center gap-3"><i class="fas fa-layer-group w-5 text-center"></i><span>Ù…ÙˆØ¶ÙˆØ¹Ø§Øª</span></div>
                    <div class="flex items-center gap-2"><span class="text-xs font-normal text-gray-400 uppercase" dir="ltr">Categories</span><i class="fas fa-chevron-down transition-transform"></i></div>
                </button>
                <div id="categoriesAccordionContent" class="hidden bg-black/20 px-2 py-1 rounded-b-lg"></div>
            </div>
            <div class="p-2">
                <button id="countriesAccordionBtn" class="w-full flex justify-between items-center px-4 py-3 text-left font-bold hover:bg-[var(--highlight-bg)] transition-colors rounded-lg text-xs">
                    <div class="flex items-center gap-3"><i class="fas fa-flag w-5 text-center"></i><span>Ú©Ø´ÙˆØ±Ù‡Ø§</span></div>
                    <div class="flex items-center gap-2"><span class="text-xs font-normal text-gray-400 uppercase" dir="ltr">Countries</span><i class="fas fa-chevron-down transition-transform"></i></div>
                </button>
                <div id="countriesAccordionContent" class="hidden bg-black/20 px-2 py-1 rounded-b-lg"></div>
            </div>
        </div>
        
        <div class="mt-auto">
            <div id="install-container" class="p-2 border-t border-[var(--border-color)]" style="display: none;">
                <div class="flex items-center gap-3 px-4 py-1">
                    <button id="menu-install-btn" class="flex-grow flex items-center gap-3 font-bold text-left p-2 -mr-2 -my-2 hover:bg-[var(--highlight-bg)] rounded-lg transition-colors text-xs">
                        <i class="fas fa-download w-5 text-center" style="color: var(--accent-primary);"></i>
                        <span>Ù†ØµØ¨ Ø¨ØµÙˆØ±Øª Ø¨Ø±Ù†Ø§Ù…Ù‡</span>
                    </button>
                    <div class="relative flex-shrink-0" id="install-tooltip-container">
                        <i class="fas fa-question-circle text-[var(--text-secondary)] cursor-help text-base"></i>
                        <div id="install-tooltip" class="absolute bottom-full right-0 mb-2 w-72 p-3 rounded-lg glass-effect text-xs shadow-lg opacity-0 invisible transition-opacity duration-300 pointer-events-none z-10">
                            <p class="mb-2">Ø§ÛŒÙ† Ø¯Ú©Ù…Ù‡ Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ ØºÛŒØ±ÙØ¹Ø§Ù„ (Ø®Ø§Ú©Ø³ØªØ±ÛŒ) Ø®ÙˆØ§Ù‡Ø¯ Ø¨ÙˆØ¯ Ùˆ Ø¨Ù‡ Ù…Ø­Ø¶ Ø§ÛŒÙ†Ú©Ù‡ Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø¬Ø§Ø²Ù‡ Ù†ØµØ¨ Ø±Ø§ Ø¨Ø¯Ù‡Ø¯ØŒ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± ÙØ¹Ø§Ù„ Ùˆ Ù‚Ø§Ø¨Ù„ Ú©Ù„ÛŒÚ© Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>
                            <p class="font-bold mb-1">Ù‡Ù…Ú†Ù†ÛŒÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² Ù…Ù†ÙˆÛŒ Ù…Ø±ÙˆØ±Ú¯Ø± (Ø³Ù‡ Ù†Ù‚Ø·Ù‡) Ú¯Ø²ÛŒÙ†Ù‡ "Add to Home Screen" ÛŒØ§ "Install App" Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div id="theme-customizer-container" class="p-4 border-t border-[var(--border-color)]">
                <h3 class="font-bold mb-3 text-center text-sm">Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ Ø±Ù†Ú¯ ØªÙ…</h3>
                <div id="color-picker" class="flex justify-center gap-3"></div>
            </div>
        </div>

        <div class="p-4 border-t border-[var(--border-color)] flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="https://t.me/Paradise_Of_Freedom" target="_blank" rel="noopener noreferrer" class="text-[var(--text-secondary)] hover:text-[var(--accent-primary)] transition-colors text-xl"><i class="fab fa-telegram"></i></a>
                <a href="https://x.com/mansor427" target="_blank" rel="noopener noreferrer" class="text-[var(--text-secondary)] hover:text-[var(--accent-primary)] transition-colors text-xl"><i class="fab fa-x-twitter"></i></a>
                <a href="https://github.com/darknessm427" target="_blank" rel="noopener noreferrer" class="text-[var(--text-secondary)] hover:text-[var(--accent-primary)] transition-colors text-xl"><i class="fab fa-github"></i></a>
            </div>
            <img src="https://github.com/user-attachments/assets/3ec2a5a4-2bec-4af5-a976-e45f985dd63e" alt="Ù„ÙˆÚ¯Ùˆ" class="opacity-30 w-1/4">
        </div>
    </div>

    <div id="menuOverlay" class="fixed inset-0 bg-black/60 z-40 opacity-0 pointer-events-none"></div>

    <main class="container mx-auto p-4">
        <div id="search-filter-section" class="max-w-2xl mx-auto my-8 px-4">
            <div class="text-center mb-8">
                <h2 id="main-title" class="text-xl font-bold mb-2">Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§</h2>
                <p id="main-subtitle" class="text-[var(--text-secondary)] text-sm">ÛŒÚ© Ù…ÙˆØ¶ÙˆØ¹ ÛŒØ§ Ú©Ø´ÙˆØ± Ø±Ø§ Ø§Ø² Ù…Ù†Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>
            </div>
            <div class="glass-effect rounded-xl p-6 space-y-6">
                <div class="relative"><input type="text" id="channelSearch" class="w-full pl-4 pr-12 py-3 rounded-lg border focus:ring-2 focus:outline-none transition-all bg-[var(--bg-primary)] border-[var(--border-color)] text-[var(--text-primary)] text-sm" style="--tw-ring-color: var(--accent-primary);" placeholder="Ù†Ø§Ù… Ú©Ø§Ù†Ø§Ù„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."><i class="fas fa-search absolute right-4 top-1/2 -translate-y-1/2 text-[var(--text-secondary)]"></i></div>
                <div class="flex flex-wrap gap-2 justify-center" id="sourceFilters">
                    <button onclick="toggleSourceFilter('all')" class="filter-btn active border border-[var(--border-color)] rounded-lg px-4 py-2 transition-all duration-300 text-sm" data-filter="all"><i class="fas fa-border-all mr-2"></i>Ù‡Ù…Ù‡</button>
                    <button onclick="toggleSourceFilter('iptv')" class="filter-btn border border-[var(--border-color)] rounded-lg px-4 py-2 transition-all duration-300 text-sm" data-filter="iptv"><i class="fas fa-tv mr-2"></i>IPTV</button>
                    <button onclick="toggleSourceFilter('youtube')" class="filter-btn border border-[var(--border-color)] rounded-lg px-4 py-2 transition-all duration-300 text-sm" data-filter="youtube"><i class="fab fa-youtube mr-2"></i>YouTube</button>
                </div>
            </div>
        </div>
        
        <div id="resultsCount" class="text-center mb-6 hidden text-[var(--text-secondary)] text-sm"><span class="font-semibold text-[var(--text-primary)]" id="channelCount">0</span> Ø¢ÛŒØªÙ… ÛŒØ§ÙØª Ø´Ø¯</div>
        
        <div id="channelGrid" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4"></div>
        <div id="recordingsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 hidden"></div>
        
        <div id="noResults" class="text-center py-12 hidden"><div class="mb-4 text-[var(--text-secondary)]"><i class="fas fa-search text-4xl"></i></div><h3 class="text-lg font-semibold mb-2">Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h3><p class="text-[var(--text-secondary)] text-sm" id="noResultsMessage">Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ø¹Ø¨Ø§Ø±Øª Ø¯ÛŒÚ¯Ø±ÛŒ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯</p></div>
    </main>

    <div id="playerModal" class="hidden fixed inset-0 z-50" style="background-color: rgba(var(--bg-primary-rgb, 10, 10, 10), 0.9); backdrop-filter: blur(8px);">
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="glass-effect rounded-2xl w-full max-w-4xl overflow-hidden modal-animation flex flex-col">
                <div class="p-4 flex justify-between items-center border-b border-[var(--border-color)] flex-shrink-0">
                    <h2 id="channelTitle" class="text-lg font-bold truncate pr-4"></h2>
                    <button onclick="closePlayer()" class="w-8 h-8 flex items-center justify-center rounded-full transition-colors bg-[var(--bg-primary)] hover:bg-[var(--highlight-bg)]"><i class="fas fa-times"></i></button>
                </div>
                <div id="playerContainer" class="aspect-w-16 aspect-h-9 bg-black relative flex-grow"></div>
                <div class="p-3 flex flex-col gap-2 flex-shrink-0" style="background-color: rgba(var(--bg-primary-rgb, 10, 10, 10), 0.5);">
                    <!-- Main Controls -->
                    <div class="flex flex-wrap items-center gap-2">
                        <button id="toggleIPTV" class="flex-1 px-4 py-2 rounded-lg neon-button border border-[var(--accent-primary)] text-[var(--accent-primary)] transition-all duration-300 hidden text-sm"><i class="fas fa-tv mr-2"></i>IPTV</button>
                        <button id="toggleYouTube" class="flex-1 px-4 py-2 rounded-lg neon-button border border-[var(--accent-primary)] text-[var(--accent-primary)] transition-all duration-300 hidden text-sm"><i class="fab fa-youtube mr-2"></i>YouTube</button>
                        <div class="flex-grow"></div>
                        <button id="pipBtn" class="w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-lg neon-button border border-[var(--accent-primary)] text-[var(--accent-primary)] transition-all duration-300 hidden" title="ØªØµÙˆÛŒØ± Ø¯Ø± ØªØµÙˆÛŒØ±"><i class="fas fa-clone"></i></button>
                        <button id="shareBtn" class="w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-lg neon-button border border-[var(--accent-primary)] text-[var(--accent-primary)] transition-all duration-300 hidden" title="Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ"><i class="fas fa-share-alt"></i></button>
                        <button id="fullscreenBtn" class="w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-lg neon-button border border-[var(--accent-primary)] text-[var(--accent-primary)] transition-all duration-300 hidden" title="ØªÙ…Ø§Ù… ØµÙØ­Ù‡"><i class="fas fa-expand"></i></button>
                    </div>
                    <!-- Advanced Controls -->
                    <div class="flex flex-wrap items-center gap-2 border-t border-[var(--border-color)] pt-2">
                         <!-- Recording -->
                        <button id="recordBtn" class="flex-shrink-0 flex items-center justify-center neon-button border transition-all duration-300 hidden" title="Ø¶Ø¨Ø· ÙˆÛŒØ¯ÛŒÙˆ"><i class="fas fa-circle"></i></button>
                        <div id="recordControlsContainer" class="flex items-center gap-2 hidden">
                            <i class="fas fa-cog text-[var(--text-secondary)]"></i>
                            <select id="recordingQualitySelect" class="player-select" title="Ú©ÛŒÙÛŒØª Ø¶Ø¨Ø·">
                                <option value="source">Ú©ÛŒÙÛŒØª Ù…Ù†Ø¨Ø¹</option>
                                <option value="high">Ø¨Ø§Ù„Ø§ (2.5Mbps)</option>
                                <option value="medium">Ù…ØªÙˆØ³Ø· (1Mbps)</option>
                                <option value="low">Ù¾Ø§ÛŒÛŒÙ† (500kbps)</option>
                            </select>
                        </div>
                        <div class="flex-grow"></div>
                        <!-- Audio Only -->
                        <button id="audioOnlyBtn" class="w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-lg neon-button border border-[var(--accent-primary)] text-[var(--accent-primary)] transition-all duration-300 hidden" title="ÙÙ‚Ø· ØµØ¯Ø§"><i class="fas fa-music"></i></button>
                        <!-- Playback Quality -->
                        <div id="qualityControlContainer" class="flex items-center gap-2 hidden">
                            <i class="fas fa-sliders-h text-[var(--text-secondary)]"></i>
                            <select id="qualitySelect" class="player-select" title="Ú©ÛŒÙÛŒØª Ù¾Ø®Ø´"></select>
                        </div>
                        <!-- Playback Speed -->
                        <div id="speedControlContainer" class="flex items-center gap-2 hidden">
                            <i class="fas fa-gauge-high text-[var(--text-secondary)]"></i>
                            <select id="playbackSpeedSelect" class="player-select" title="Ø³Ø±Ø¹Øª Ù¾Ø®Ø´">
                                <option value="0.5">0.5x</option>
                                <option value="0.75">0.75x</option>
                                <option value="1" selected>1x (Ø¹Ø§Ø¯ÛŒ)</option>
                                <option value="1.25">1.25x</option>
                                <option value="1.5">1.5x</option>
                                <option value="2">2x</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(reg => console.log('SW registered'), err => console.error('SW registration failed: ', err));
            });
        }
        
        // --- PWA INSTALL PROMPT ---
        const menuInstallBtn = document.getElementById('menu-install-btn');
        const installContainer = document.getElementById('install-container');
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (installContainer && menuInstallBtn) {
                installContainer.style.display = 'block';
                menuInstallBtn.disabled = false;
            }
        });

        if (menuInstallBtn) {
            menuInstallBtn.addEventListener('click', async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                await deferredPrompt.userChoice;
                deferredPrompt = null;
                if (installContainer) installContainer.style.display = 'none';
            });
        }

        window.addEventListener('appinstalled', () => {
            deferredPrompt = null;
            if (installContainer) installContainer.style.display = 'none';
            showToast('Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù†ØµØ¨ Ø´Ø¯!', 'success');
        });

        function setupInstallButton() {
            if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) return;
            if (installContainer && menuInstallBtn) {
                installContainer.style.display = 'block';
                menuInstallBtn.disabled = true;
            }
        }

        // --- THEME & COLOR ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const colorPicker = document.getElementById('color-picker');
        const themeCustomizer = document.getElementById('theme-customizer-container');
        const body = document.body;
        const THEME_COLORS = { cyan: '#00ffff', blue: '#0d6efd', purple: '#8442ff', pink: '#ff0073', green: '#00ff7f', orange: '#ffa500' };

        function applyTheme(theme) {
            body.classList.toggle('light-theme', theme === 'light');
            themeToggleBtn.innerHTML = theme === 'light' ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
            const isLight = theme === 'light';
            document.documentElement.style.setProperty('--bg-primary-rgb', isLight ? '248, 249, 250' : '10, 10, 10');
            document.documentElement.style.setProperty('--bg-secondary-rgb', isLight ? '255, 255, 255' : '26, 26, 26');

            if (themeCustomizer) themeCustomizer.style.display = isLight ? 'none' : 'block';
            if (isLight) {
                ['--accent-primary', '--shadow-color', '--highlight-bg', '--accent-primary-rgb'].forEach(prop => document.documentElement.style.removeProperty(prop));
            } else {
                applyAccentColor(localStorage.getItem('theme_color_name') || 'cyan');
            }
        }

        function applyAccentColor(colorName) {
            if (body.classList.contains('light-theme')) return;
            const colorValue = THEME_COLORS[colorName];
            const rgb = colorValue.match(/\w\w/g).map(x => parseInt(x, 16));
            document.documentElement.style.setProperty('--accent-primary', colorValue);
            document.documentElement.style.setProperty('--shadow-color', `rgba(${rgb.join(',')}, 0.3)`);
            document.documentElement.style.setProperty('--highlight-bg', `rgba(${rgb.join(',')}, 0.1)`);
            document.documentElement.style.setProperty('--accent-primary-rgb', rgb.join(','));
            localStorage.setItem('theme_color_name', colorName);
            updateColorSwatches(colorName);
        }
        
        function populateColorPicker() {
            if (!colorPicker) return;
            colorPicker.innerHTML = Object.entries(THEME_COLORS).map(([name, color]) => `
                <div class="color-swatch" style="background-color: ${color};" data-color="${name}" onclick="applyAccentColor('${name}')"></div>
            `).join('');
        }

        function updateColorSwatches(activeColorName) {
            if (!colorPicker) return;
            colorPicker.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.classList.toggle('active', swatch.dataset.color === activeColorName);
            });
        }

        function loadSavedTheme() {
            applyTheme(localStorage.getItem('theme') || 'dark');
        }

        // --- APPLICATION LOGIC ---
        const COUNTRIES_METADATA_URL = 'https://raw.githubusercontent.com/TVGarden/tv-garden-channel-list/main/channels/raw/countries_metadata.json';
        const COUNTRY_BASE_URL = 'https://raw.githubusercontent.com/TVGarden/tv-garden-channel-list/main/channels/raw/countries/';
        const CATEGORIES_BASE_URL = 'https://raw.githubusercontent.com/TVGarden/tv-garden-channel-list/main/channels/raw/categories/';
        const FLAG_API_BASE = 'https://flagcdn.com/w80/';
        const FLAG_COUNTRY_MAPPINGS = { 'UK': 'gb', 'GB': 'gb' };
        
        const CATEGORIES = [{id:'animation',name_fa:'Ø§Ù†ÛŒÙ…ÛŒØ´Ù†',name_en:'Animation',icon:'fa-film'},{id:'auto',name_fa:'Ø®ÙˆØ¯Ø±Ùˆ',name_en:'Auto',icon:'fa-car'},{id:'business',name_fa:'Ú©Ø³Ø¨ Ùˆ Ú©Ø§Ø±',name_en:'Business',icon:'fa-briefcase'},{id:'classic',name_fa:'Ú©Ù„Ø§Ø³ÛŒÚ©',name_en:'Classic',icon:'fa-landmark'},{id:'comedy',name_fa:'Ú©Ù…Ø¯ÛŒ',name_en:'Comedy',icon:'fa-masks-theater'},{id:'cooking',name_fa:'Ø¢Ø´Ù¾Ø²ÛŒ',name_en:'Cooking',icon:'fa-utensils'},{id:'culture',name_fa:'ÙØ±Ù‡Ù†Ú¯',name_en:'Culture',icon:'fa-palette'},{id:'documentary',name_fa:'Ù…Ø³ØªÙ†Ø¯',name_en:'Documentary',icon:'fa-camera-retro'},{id:'education',name_fa:'Ø¢Ù…ÙˆØ²Ø´ÛŒ',name_en:'Education',icon:'fa-graduation-cap'},{id:'entertainment',name_fa:'Ø³Ø±Ú¯Ø±Ù…ÛŒ',name_en:'Entertainment',icon:'fa-gamepad'},{id:'family',name_fa:'Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ',name_en:'Family',icon:'fa-users'},{id:'general',name_fa:'Ø¹Ù…ÙˆÙ…ÛŒ',name_en:'General',icon:'fa-tv'},{id:'history',name_fa:'ØªØ§Ø±ÛŒØ®',name_en:'History',icon:'fa-scroll'},{id:'hobby',name_fa:'Ø³Ø±Ú¯Ø±Ù…ÛŒ',name_en:'Hobby',icon:'fa-puzzle-piece'},{id:'kids',name_fa:'Ú©ÙˆØ¯Ú©Ø§Ù†',name_en:'Kids',icon:'fa-child-reaching'},{id:'legislative',name_fa:'Ù‚Ø§Ù†ÙˆÙ† Ú¯Ø°Ø§Ø±ÛŒ',name_en:'Legislative',icon:'fa-gavel'},{id:'lifestyle',name_fa:'Ø³Ø¨Ú© Ø²Ù†Ø¯Ú¯ÛŒ',name_en:'Lifestyle',icon:'fa-person-walking'},{id:'local',name_fa:'Ù…Ø­Ù„ÛŒ',name_en:'Local',icon:'fa-map-marker-alt'},{id:'movies',name_fa:'ÙÛŒÙ„Ù…',name_en:'Movies',icon:'fa-clapperboard'},{id:'music',name_fa:'Ù…ÙˆØ³ÛŒÙ‚ÛŒ',name_en:'Music',icon:'fa-music'},{id:'news',name_fa:'Ø§Ø®Ø¨Ø§Ø±',name_en:'News',icon:'fa-newspaper'},{id:'politics',name_fa:'Ø³ÛŒØ§Ø³ÛŒ',name_en:'Politics',icon:'fa-landmark-dome'},{id:'religious',name_fa:'Ù…Ø°Ù‡Ø¨ÛŒ',name_en:'Religious',icon:'fa-place-of-worship'},{id:'series',name_fa:'Ø³Ø±ÛŒØ§Ù„',name_en:'Series',icon:'fa-photo-film'},{id:'science',name_fa:'Ø¹Ù„Ù…ÛŒ',name_en:'Science',icon:'fa-flask'},{id:'shop',name_fa:'ÙØ±ÙˆØ´Ú¯Ø§Ù‡ÛŒ',name_en:'Shop',icon:'fa-shopping-cart'},{id:'sports',name_fa:'ÙˆØ±Ø²Ø´ÛŒ',name_en:'Sports',icon:'fa-futbol'},{id:'travel',name_fa:'Ø³ÙØ±',name_en:'Travel',icon:'fa-plane-departure'},{id:'weather',name_fa:'Ø¢Ø¨ Ùˆ Ù‡ÙˆØ§',name_en:'Weather',icon:'fa-cloud-sun'}];
        const COUNTRY_NAME_MAP_FA = {"Afghanistan":"Ø§ÙØºØ§Ù†Ø³ØªØ§Ù†","Albania":"Ø¢Ù„Ø¨Ø§Ù†ÛŒ","Algeria":"Ø§Ù„Ø¬Ø²Ø§ÛŒØ±","Andorra":"Ø¢Ù†Ø¯ÙˆØ±Ø§","Argentina":"Ø¢Ø±Ú˜Ø§Ù†ØªÛŒÙ†","Armenia":"Ø§Ø±Ù…Ù†Ø³ØªØ§Ù†","Australia":"Ø§Ø³ØªØ±Ø§Ù„ÛŒØ§","Austria":"Ø§ØªØ±ÛŒØ´","Azerbaijan":"Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§Ù†","Bangladesh":"Ø¨Ù†Ú¯Ù„Ø§Ø¯Ø´","Belarus":"Ø¨Ù„Ø§Ø±ÙˆØ³","Belgium":"Ø¨Ù„Ú˜ÛŒÚ©","Bolivia":"Ø¨ÙˆÙ„ÛŒÙˆÛŒ","Bosnia and Herzegovina":"Ø¨ÙˆØ³Ù†ÛŒ Ùˆ Ù‡Ø±Ø²Ú¯ÙˆÛŒÙ†","Brazil":"Ø¨Ø±Ø²ÛŒÙ„","Bulgaria":"Ø¨Ù„ØºØ§Ø±Ø³ØªØ§Ù†","Canada":"Ú©Ø§Ù†Ø§Ø¯Ø§","Chile":"Ø´ÛŒÙ„ÛŒ","China":"Ú†ÛŒÙ†","Colombia":"Ú©Ù„Ù…Ø¨ÛŒØ§","Croatia":"Ú©Ø±ÙˆØ§Ø³ÛŒ","Cuba":"Ú©ÙˆØ¨Ø§","Cyprus":"Ù‚Ø¨Ø±Ø³","Czechia":"Ú†Ú©","Denmark":"Ø¯Ø§Ù†Ù…Ø§Ø±Ú©","Ecuador":"Ø§Ú©ÙˆØ§Ø¯ÙˆØ±","Egypt":"Ù…ØµØ±","Estonia":"Ø§Ø³ØªÙˆÙ†ÛŒ","Finland":"ÙÙ†Ù„Ø§Ù†Ø¯","France":"ÙØ±Ø§Ù†Ø³Ù‡","Georgia":"Ú¯Ø±Ø¬Ø³ØªØ§Ù†","Germany":"Ø¢Ù„Ù…Ø§Ù†","Greece":"ÛŒÙˆÙ†Ø§Ù†","Hungary":"Ù…Ø¬Ø§Ø±Ø³ØªØ§Ù†","Iceland":"Ø§ÛŒØ³Ù„Ù†Ø¯","India":"Ù‡Ù†Ø¯","Indonesia":"Ø§Ù†Ø¯ÙˆÙ†Ø²ÛŒ","Iran":"Ø§ÛŒØ±Ø§Ù†","Iraq":"Ø¹Ø±Ø§Ù‚","Ireland":"Ø§ÛŒØ±Ù„Ù†Ø¯","Israel":"Ø§Ø³Ø±Ø§Ø¦ÛŒÙ„","Italy":"Ø§ÛŒØªØ§Ù„ÛŒØ§","Japan":"Ú˜Ø§Ù¾Ù†","Kazakhstan":"Ù‚Ø²Ø§Ù‚Ø³ØªØ§Ù†","Kuwait":"Ú©ÙˆÛŒØª","Latvia":"Ù„ØªÙˆÙ†ÛŒ","Lebanon":"Ù„Ø¨Ù†Ø§Ù†","Libya":"Ù„ÛŒØ¨ÛŒ","Lithuania":"Ù„ÛŒØªÙˆØ§Ù†ÛŒ","Luxembourg":"Ù„ÙˆÚ©Ø²Ø§Ù…Ø¨ÙˆØ±Ú¯","Malaysia":"Ù…Ø§Ù„Ø²ÛŒ","Malta":"Ù…Ø§Ù„Øª","Mexico":"Ù…Ú©Ø²ÛŒÚ©","Moldova":"Ù…ÙˆÙ„Ø¯Ø§ÙˆÛŒ","Monaco":"Ù…ÙˆÙ†Ø§Ú©Ùˆ","Montenegro":"Ù…ÙˆÙ†ØªÙ‡â€ŒÙ†Ú¯Ø±Ùˆ","Morocco":"Ù…Ø±Ø§Ú©Ø´","Netherlands":"Ù‡Ù„Ù†Ø¯","New Zealand":"Ù†ÛŒÙˆØ²ÛŒÙ„Ù†Ø¯","North Korea":"Ú©Ø±Ù‡ Ø´Ù…Ø§Ù„ÛŒ","North Macedonia":"Ù…Ù‚Ø¯ÙˆÙ†ÛŒÙ‡ Ø´Ù…Ø§Ù„ÛŒ","Norway":"Ù†Ø±ÙˆÚ˜","Pakistan":"Ù¾Ø§Ú©Ø³ØªØ§Ù†","Palestine":"ÙÙ„Ø³Ø·ÛŒÙ†","Paraguay":"Ù¾Ø§Ø±Ø§Ú¯ÙˆØ¦Ù‡","Peru":"Ù¾Ø±Ùˆ","Philippines":"ÙÛŒÙ„ÛŒÙ¾ÛŒÙ†","Poland":"Ù„Ù‡Ø³ØªØ§Ù†","Portugal":"Ù¾Ø±ØªØºØ§Ù„","Qatar":"Ù‚Ø·Ø±","Romania":"Ø±ÙˆÙ…Ø§Ù†ÛŒ","Russia":"Ø±ÙˆØ³ÛŒÙ‡","San Marino":"Ø³Ø§Ù† Ù…Ø§Ø±ÛŒÙ†Ùˆ","Saudi Arabia":"Ø¹Ø±Ø¨Ø³ØªØ§Ù† Ø³Ø¹ÙˆØ¯ÛŒ","Serbia":"ØµØ±Ø¨Ø³ØªØ§Ù†","Singapore":"Ø³Ù†Ú¯Ø§Ù¾ÙˆØ±","Slovakia":"Ø§Ø³Ù„ÙˆØ§Ú©ÛŒ","Slovenia":"Ø§Ø³Ù„ÙˆÙˆÙ†ÛŒ","South Africa":"Ø¢ÙØ±ÛŒÙ‚Ø§ÛŒ Ø¬Ù†ÙˆØ¨ÛŒ","South Korea":"Ú©Ø±Ù‡ Ø¬Ù†ÙˆØ¨ÛŒ","Spain":"Ø§Ø³Ù¾Ø§Ù†ÛŒØ§","Sweden":"Ø³ÙˆØ¦Ø¯","Switzerland":"Ø³ÙˆØ¦ÛŒØ³","Syria":"Ø³ÙˆØ±ÛŒÙ‡","Taiwan":"ØªØ§ÛŒÙˆØ§Ù†","Thailand":"ØªØ§ÛŒÙ„Ù†Ø¯","Tunisia":"ØªÙˆÙ†Ø³","Turkey":"ØªØ±Ú©ÛŒÙ‡","Turkmenistan":"ØªØ±Ú©Ù…Ù†Ø³ØªØ§Ù†","Ukraine":"Ø§ÙˆÚ©Ø±Ø§ÛŒÙ†","United Arab Emirates":"Ø§Ù…Ø§Ø±Ø§Øª Ù…ØªØ­Ø¯Ù‡ Ø¹Ø±Ø¨ÛŒ","United Kingdom":"Ø¨Ø±ÛŒØªØ§Ù†ÛŒØ§","United States":"Ø§ÛŒØ§Ù„Ø§Øª Ù…ØªØ­Ø¯Ù‡","Uruguay":"Ø§Ø±ÙˆÚ¯ÙˆØ¦Ù‡","Uzbekistan":"Ø§Ø²Ø¨Ú©Ø³ØªØ§Ù†","Venezuela":"ÙˆÙ†Ø²ÙˆØ¦Ù„Ø§","Vietnam":"ÙˆÛŒØªÙ†Ø§Ù…","Yemen":"ÛŒÙ…Ù†"};
        
        // --- DOM Elements ---
        const channelGrid = document.getElementById('channelGrid');
        const recordingsGrid = document.getElementById('recordingsGrid');
        const playerModal = document.getElementById('playerModal');
        const channelTitle = document.getElementById('channelTitle');
        const playerContainer = document.getElementById('playerContainer');
        const toggleIPTVBtn = document.getElementById('toggleIPTV');
        const toggleYouTubeBtn = document.getElementById('toggleYouTube');
        const pipBtn = document.getElementById('pipBtn');
        const shareBtn = document.getElementById('shareBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const recordBtn = document.getElementById('recordBtn');
        const recordControlsContainer = document.getElementById('recordControlsContainer');
        const recordingQualitySelect = document.getElementById('recordingQualitySelect');
        const speedControlContainer = document.getElementById('speedControlContainer');
        const playbackSpeedSelect = document.getElementById('playbackSpeedSelect');
        const qualityControlContainer = document.getElementById('qualityControlContainer');
        const qualitySelect = document.getElementById('qualitySelect');
        const audioOnlyBtn = document.getElementById('audioOnlyBtn');
        
        // --- State Variables ---
        let currentChannelForModal = null;
        let currentPlayer = null, currentHls = null;
        let countriesData = null, currentChannels = [], allChannels = [];
        let favorites = [];
        let lastSelected = { type: 'country', id: 'IR' };
        
        // --- Recording State ---
        let db;
        let mediaRecorder;
        let recordedBlobs;
        let isRecording = false;
        let recordingTimerInterval;
        let recordingStartTime;

        // --- INITIALIZATION ---
        async function init() {
            setupInstallButton();
            populateColorPicker();
            loadSavedTheme();
            loadFavorites();
            await initDB();
            
            // Event Listeners
            themeToggleBtn.addEventListener('click', () => {
                const newTheme = body.classList.contains('light-theme') ? 'dark' : 'light';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });
            
            pipBtn.addEventListener('click', togglePiP);
            shareBtn.addEventListener('click', shareChannel);
            fullscreenBtn.addEventListener('click', toggleFullScreen);
            recordBtn.addEventListener('click', toggleRecording);
            playbackSpeedSelect.addEventListener('change', setPlaybackSpeed);
            qualitySelect.addEventListener('change', setPlaybackQuality);
            audioOnlyBtn.addEventListener('click', toggleAudioOnly);


            document.getElementById('openMenuBtn').addEventListener('click', () => {
                document.getElementById('sideMenu').classList.add('open');
                document.getElementById('menuOverlay').classList.add('open');
            });
            const closeMenu = () => {
                document.getElementById('sideMenu').classList.remove('open');
                document.getElementById('menuOverlay').classList.remove('open');
            };
            document.getElementById('closeMenuBtn').addEventListener('click', closeMenu);
            document.getElementById('menuOverlay').addEventListener('click', closeMenu);
            
            document.getElementById('favoritesBtn').addEventListener('click', () => { selectFavorites(); closeMenu(); });
            document.getElementById('allChannelsBtn').addEventListener('click', () => { selectAllWindows(); closeMenu(); });
            document.getElementById('recordingsBtn').addEventListener('click', () => { selectRecordings(); closeMenu(); });
            
            document.getElementById('countriesAccordionBtn').addEventListener('click', () => toggleAccordion('countries'));
            document.getElementById('categoriesAccordionBtn').addEventListener('click', () => toggleAccordion('categories'));
            
            document.getElementById('channelSearch').addEventListener('input', () => setTimeout(filterAndDisplay, 300));

            try {
                const response = await fetch(COUNTRIES_METADATA_URL);
                countriesData = await response.json();
                Object.keys(countriesData).forEach(code => {
                    countriesData[code].country_fa = COUNTRY_NAME_MAP_FA[countriesData[code].country] || countriesData[code].country;
                });
                populateCountriesList(countriesData);
                populateCategoriesList();
                
                await checkForSharedChannel();

                if (!lastSelected.type) {
                    selectCountry('IR', countriesData['IR']);
                }
                
                await fetchAllChannels(countriesData);
                selectCountry('IR', countriesData['IR']); // Default to Iran
            } catch (error) {
                console.error('Initialization failed:', error);
                showError('Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡.');
            }
        }
        
        // --- DATABASE (IndexedDB for Recordings) ---
        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('TVRecordingsDB', 1);
                request.onupgradeneeded = event => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('recordings')) {
                        db.createObjectStore('recordings', { keyPath: 'id', autoIncrement: true });
                    }
                };
                request.onsuccess = event => {
                    db = event.target.result;
                    resolve();
                };
                request.onerror = event => {
                    console.error('Database error:', event.target.error);
                    showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ Ø¶Ø¨Ø·â€ŒÙ‡Ø§', 'error');
                    reject(event.target.error);
                };
            });
        }

        async function saveRecording(blob) {
            if (!db) return;
            const transaction = db.transaction(['recordings'], 'readwrite');
            const store = transaction.objectStore('recordings');
            const recordingData = {
                channelName: currentChannelForModal?.name || 'Unknown Channel',
                timestamp: new Date(),
                videoBlob: blob
            };
            const request = store.add(recordingData);
            request.onsuccess = () => showToast(`"${recordingData.channelName}" Ø¶Ø¨Ø· Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯`, 'success');
            request.onerror = (e) => {
                console.error('Could not save recording:', e.target.error);
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ÙˆÛŒØ¯ÛŒÙˆ', 'error');
            };
        }

        async function getRecordings() {
            if (!db) return [];
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['recordings'], 'readonly');
                const store = transaction.objectStore('recordings');
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }
        
        async function deleteRecording(id) {
            if (!db) return;
            const transaction = db.transaction(['recordings'], 'readwrite');
            const store = transaction.objectStore('recordings');
            const request = store.delete(id);
            request.onsuccess = () => {
                showToast('ÙˆÛŒØ¯ÛŒÙˆ Ø­Ø°Ù Ø´Ø¯', 'success');
                selectRecordings(); // Refresh view
            };
             request.onerror = (e) => {
                console.error('Could not delete recording:', e.target.error);
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ÙˆÛŒØ¯ÛŒÙˆ', 'error');
            };
        }
        
        // --- RECORDING LOGIC ---
        function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            if (!currentPlayer || !(currentPlayer instanceof HTMLVideoElement)) {
                showToast('Ø¶Ø¨Ø· ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ÛŒ IPTV Ø§Ù…Ú©Ø§Ù†â€ŒÙ¾Ø°ÛŒØ± Ø§Ø³Øª.', 'error');
                return;
            }
            const stream = currentPlayer.captureStream();
            if (!stream) {
                 showToast('Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ø§Ø³ØªØ±ÛŒÙ… ÙˆÛŒØ¯ÛŒÙˆ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø¶Ø¨Ø· Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯.', 'error');
                return;
            }
            
            recordedBlobs = [];
            const recorderOptions = { mimeType: 'video/webm; codecs=vp9' };
            const quality = recordingQualitySelect.value;
            switch(quality) {
                case 'high': recorderOptions.videoBitsPerSecond = 2500000; break;
                case 'medium': recorderOptions.videoBitsPerSecond = 1000000; break;
                case 'low': recorderOptions.videoBitsPerSecond = 500000; break;
            }

            try {
                mediaRecorder = new MediaRecorder(stream, recorderOptions);
            } catch (e) {
                console.error('MediaRecorder error:', e);
                try {
                     mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
                } catch (e2) {
                    showToast('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² ÙØ±Ù…Øª Ø¶Ø¨Ø· Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.', 'error');
                    return;
                }
            }

            isRecording = true;
            recordBtn.classList.add('recording');
            recordBtn.title = 'ØªÙˆÙ‚Ù Ø¶Ø¨Ø·';

            recordingStartTime = Date.now();
            updateRecordingTimer();
            recordingTimerInterval = setInterval(updateRecordingTimer, 1000);

            mediaRecorder.onstop = (event) => {
                const superBuffer = new Blob(recordedBlobs, { type: 'video/webm' });
                saveRecording(superBuffer);
            };
            
            mediaRecorder.ondataavailable = (event) => {
                if (event.data && event.data.size > 0) {
                    recordedBlobs.push(event.data);
                }
            };
            
            mediaRecorder.start(10);
            showToast('Ø¶Ø¨Ø· Ø´Ø±ÙˆØ¹ Ø´Ø¯...', 'success');
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            isRecording = false;

            clearInterval(recordingTimerInterval);
            recordBtn.innerHTML = '<i class="fas fa-circle"></i>';
            recordBtn.classList.remove('recording');
            recordBtn.title = 'Ø¶Ø¨Ø· ÙˆÛŒØ¯ÛŒÙˆ';
        }

        function updateRecordingTimer() {
            if (!isRecording) return;
            const elapsed = Date.now() - recordingStartTime;
            const seconds = Math.floor((elapsed / 1000) % 60);
            const minutes = Math.floor((elapsed / (1000 * 60)) % 60);
            const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            recordBtn.textContent = formattedTime;
        }


        // --- UI & DISPLAY ---
        function getChannelId(channel) { return `${channel.country || 'cat'}_${channel.name.replace(/[^a-zA-Z0-9]/g, '')}`; }
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.className = 'show';
            toast.classList.add(type);
            toast.querySelector('.message').textContent = message;
            toast.querySelector('.icon').innerHTML = type === 'success' ? '<i class="fas fa-check-circle text-green-500"></i>' : '<i class="fas fa-times-circle text-red-500"></i>';
            setTimeout(() => { toast.className = ''; }, 3000);
        }
        
        function showLoading(isChannels = true) {
            const grid = isChannels ? channelGrid : recordingsGrid;
            let skeletonHTML = '';
            for (let i = 0; i < 18; i++) {
                skeletonHTML += `
                    <div class="skeleton-card rounded-xl h-28 p-4 flex flex-col justify-between">
                        <div class="h-4 bg-[var(--border-color)] rounded w-3/4"></div>
                        <div class="flex justify-between items-center">
                            <div class="h-6 w-6 bg-[var(--border-color)] rounded-full"></div>
                            <div class="h-4 bg-[var(--border-color)] rounded w-1/4"></div>
                        </div>
                    </div>`;
            }
            grid.innerHTML = skeletonHTML;
            document.getElementById('noResults').classList.add('hidden');
            document.getElementById('resultsCount').classList.add('hidden');
        }
        
        function switchView(viewName) {
            channelGrid.classList.toggle('hidden', viewName !== 'channels');
            recordingsGrid.classList.toggle('hidden', viewName !== 'recordings');
            document.getElementById('search-filter-section').style.display = (viewName === 'recordings' ? 'none' : 'block');
        }
        
        function displayChannels(channels) {
            switchView('channels');
            if (channels.length === 0) {
                channelGrid.innerHTML = '';
                document.getElementById('noResultsMessage').textContent = 'Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ø¹Ø¨Ø§Ø±Øª Ø¯ÛŒÚ¯Ø±ÛŒ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯ ÛŒØ§ ÙÛŒÙ„ØªØ±Ù‡Ø§ Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯.';
                document.getElementById('noResults').classList.remove('hidden');
                return;
            }
            document.getElementById('noResults').classList.add('hidden');

            channelGrid.innerHTML = channels.map(channel => {
                const channelId = getChannelId(channel);
                const isFavorite = favorites.some(fav => getChannelId(fav) === channelId);
                return `
                <div class="channel-card glass-effect rounded-xl overflow-hidden p-4 flex flex-col justify-center items-center text-center h-28 cursor-pointer" onclick='playChannel(${JSON.stringify(channel).replace(/'/g, "\\'")})'>
                    <i class="favorite-star ${isFavorite ? 'fa-solid favorited' : 'fa-regular'} fa-star" data-channel-id="${channelId}" onclick="toggleFavorite(event, this)"></i>
                    <div class="flex-grow flex flex-col justify-center items-center">
                        <h3 class="font-semibold text-xs mb-2 text-[var(--text-primary)]">${channel.name}</h3>
                        ${channel.country ? `<img src="${FLAG_API_BASE}${FLAG_COUNTRY_MAPPINGS[channel.country.toUpperCase()] || channel.country.toLowerCase()}.png" alt="${channel.country}" class="w-6 h-4 object-cover rounded shadow-md border border-white/20 mb-2" onerror="this.style.display='none'">` : ''}
                    </div>
                    <div class="flex gap-2 text-xs justify-center">
                        ${channel.iptv_urls.length ? `<span class="px-2 py-1 rounded-full text-xs" style="background-color: var(--highlight-bg); color: var(--accent-primary);"><i class="fas fa-tv ml-1"></i>IPTV</span>` : ''}
                        ${channel.youtube_urls.length ? `<span class="px-2 py-1 rounded-full text-xs" style="background-color: rgba(var(--accent-secondary-rgb), 0.2); color: var(--accent-secondary);"><i class="fab fa-youtube ml-1"></i>YouTube</span>` : ''}
                    </div>
                </div>`;
            }).join('');
        }

        function displayRecordings(recordings) {
            switchView('recordings');
            document.getElementById('resultsCount').classList.toggle('hidden', recordings.length === 0);
            document.getElementById('channelCount').textContent = recordings.length;
            
            if (recordings.length === 0) {
                recordingsGrid.innerHTML = '';
                document.getElementById('noResultsMessage').textContent = 'Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² ÙˆÛŒØ¯ÛŒÙˆÛŒÛŒ Ø¶Ø¨Ø· Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.';
                document.getElementById('noResults').classList.remove('hidden');
                return;
            }
            document.getElementById('noResults').classList.add('hidden');
            
            recordingsGrid.innerHTML = recordings.sort((a,b) => b.timestamp - a.timestamp).map(rec => {
                const videoUrl = URL.createObjectURL(rec.videoBlob);
                return `
                <div class="recording-card glass-effect rounded-xl overflow-hidden p-4 flex flex-col justify-between">
                    <div>
                        <h3 class="font-semibold text-sm mb-2 text-[var(--text-primary)]">${rec.channelName}</h3>
                        <p class="text-xs text-[var(--text-secondary)] mb-3">${new Date(rec.timestamp).toLocaleString('fa-IR')}</p>
                    </div>
                    <div class="flex gap-2 justify-end">
                        <button onclick="playRecording('${videoUrl}', '${rec.channelName}')" class="w-10 h-10 flex items-center justify-center rounded-lg neon-button border border-[var(--accent-primary)] text-[var(--accent-primary)]"><i class="fas fa-play"></i></button>
                        <a href="${videoUrl}" download="${rec.channelName}_${rec.timestamp.toISOString()}.webm" class="w-10 h-10 flex items-center justify-center rounded-lg neon-button border border-[var(--accent-primary)] text-[var(--accent-primary)]"><i class="fas fa-download"></i></a>
                        <button onclick="deleteRecording(${rec.id})" class="w-10 h-10 flex items-center justify-center rounded-lg neon-button border" style="border-color:var(--record-color); color:var(--record-color);"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            }).join('');
        }

        function toggleFavorite(event, starIcon) {
            event.stopPropagation(); 
            const channelId = starIcon.dataset.channelId;
            const favIndex = favorites.findIndex(fav => getChannelId(fav) === channelId);
            
            if (favIndex > -1) { 
                favorites.splice(favIndex, 1);
                starIcon.classList.remove('fa-solid', 'favorited');
                starIcon.classList.add('fa-regular');
                showToast(`Ø§Ø² Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ Ø­Ø°Ù Ø´Ø¯`, 'error');
            } else { 
                const masterList = ['all', 'favorites'].includes(lastSelected.type) ? allChannels : currentChannels;
                const channel = masterList.find(ch => getChannelId(ch) === channelId);
                if (channel) {
                    favorites.push(channel);
                    starIcon.classList.add('fa-solid', 'favorited');
                    starIcon.classList.remove('fa-regular');
                    showToast(`Ø¨Ù‡ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯`, 'success');
                }
            }
            saveFavorites();
            if (lastSelected.type === 'favorites') filterAndDisplay();
        }
        
        // --- PLAYER LOGIC ---
        function playChannel(channel) {
            currentChannelForModal = channel;
            playerModal.classList.remove('hidden');
            channelTitle.textContent = channel.name;
            const hasIptv = channel.iptv_urls?.length > 0;
            const hasYoutube = channel.youtube_urls?.length > 0;
            
            toggleIPTVBtn.classList.toggle('hidden', !hasIptv);
            toggleYouTubeBtn.classList.toggle('hidden', !hasYoutube);
            shareBtn.classList.remove('hidden');
            fullscreenBtn.classList.remove('hidden');
            
            [recordBtn, recordControlsContainer, speedControlContainer, qualityControlContainer, audioOnlyBtn].forEach(el => el.classList.add('hidden'));

            if (hasIptv) toggleIPTVBtn.onclick = () => setupIPTVPlayer(channel.iptv_urls[0]);
            if (hasYoutube) toggleYouTubeBtn.onclick = () => setupYouTubePlayer(channel.youtube_urls[0]);
            
            if (playerContainer.innerHTML !== '') playerContainer.innerHTML = '';
            hasIptv ? setupIPTVPlayer(channel.iptv_urls[0]) : hasYoutube ? setupYouTubePlayer(channel.youtube_urls[0]) : null;
        }
        
        function playRecording(url, title) {
            playerModal.classList.remove('hidden');
            channelTitle.textContent = "Ù¾Ø®Ø´ Ø¶Ø¨Ø·: " + title;
            
            [toggleIPTVBtn, toggleYouTubeBtn, pipBtn, shareBtn, recordBtn, recordControlsContainer, qualityControlContainer, audioOnlyBtn].forEach(btn => btn.classList.add('hidden'));
            fullscreenBtn.classList.remove('hidden');
            speedControlContainer.classList.remove('hidden');

            playerContainer.innerHTML = `<video controls autoplay class="w-full h-full" src="${url}"></video>`;
            currentPlayer = playerContainer.querySelector('video');
            currentPlayer.oncanplay = () => {
                playbackSpeedSelect.value = 1;
                currentPlayer.playbackRate = 1;
            };
        }

        function setupIPTVPlayer(url) {
            if (currentHls) currentHls.destroy();
            playerContainer.innerHTML = `<video controls autoplay class="w-full h-full relative z-10"></video>`;
            const video = playerContainer.querySelector('video');
            currentPlayer = video;
            
            [pipBtn, recordBtn, recordControlsContainer, speedControlContainer, audioOnlyBtn].forEach(el => el.classList.remove('hidden'));
            
            playbackSpeedSelect.value = 1;
            video.playbackRate = 1;
            qualityControlContainer.classList.add('hidden');
            qualitySelect.innerHTML = '';
            recordingQualitySelect.value = 'source';
            
            // MODIFIED: Reset audio only button state
            playerContainer.classList.remove('audio-mode');
            audioOnlyBtn.classList.remove('active');
            audioOnlyBtn.innerHTML = '<i class="fas fa-music"></i>';
            audioOnlyBtn.title = 'ÙÙ‚Ø· ØµØ¯Ø§';


            if (Hls.isSupported()) {
                currentHls = new Hls();
                currentHls.loadSource(url);
                currentHls.attachMedia(video);

                currentHls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
                    if (data.levels.length > 1) {
                        qualitySelect.innerHTML = '<option value="-1">Ø®ÙˆØ¯Ú©Ø§Ø±</option>' + 
                            data.levels.map((level, index) => `<option value="${index}">${level.height}p</option>`).join('');
                        qualitySelect.value = currentHls.currentLevel;
                        qualityControlContainer.classList.remove('hidden');
                    }
                });

            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url;
            }
            toggleIPTVBtn.style.opacity = '1'; toggleYouTubeBtn.style.opacity = '0.5';
        }

        function setupYouTubePlayer(url) {
            if (currentHls) currentHls.destroy();
            currentPlayer = null;
            
            [pipBtn, recordBtn, recordControlsContainer, speedControlContainer, qualityControlContainer, audioOnlyBtn].forEach(el => el.classList.add('hidden'));

            const videoId = new URL(url).searchParams.get('v');
            playerContainer.innerHTML = `<iframe class="w-full h-full" src="https://www.youtube.com/embed/${videoId}?autoplay=1" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>`;
            toggleYouTubeBtn.style.opacity = '1'; toggleIPTVBtn.style.opacity = '0.5';
        }

        function closePlayer() {
            if (isRecording) stopRecording();
            playerModal.classList.add('hidden');
            if (currentHls) currentHls.destroy();
            playerContainer.innerHTML = '';
            currentPlayer = null;
            currentChannelForModal = null;
            
            // MODIFIED: Reset audio only button state on close
            playerContainer.classList.remove('audio-mode');
            audioOnlyBtn.classList.remove('active');
            audioOnlyBtn.innerHTML = '<i class="fas fa-music"></i>';
            audioOnlyBtn.title = 'ÙÙ‚Ø· ØµØ¯Ø§';

            if (document.pictureInPictureElement) document.exitPictureInPicture();
            if (document.fullscreenElement) document.exitFullscreen();
        }
        
        async function togglePiP() {
            if (!currentPlayer) return;
            try {
                if (document.pictureInPictureElement) {
                    await document.exitPictureInPicture();
                } else {
                    await currentPlayer.requestPictureInPicture();
                }
            } catch (error) { showToast('Ø®Ø·Ø§ Ø¯Ø± ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ØªØµÙˆÛŒØ± Ø¯Ø± ØªØµÙˆÛŒØ±', 'error'); }
        }
        
        function setPlaybackSpeed(event) {
            if (currentPlayer) {
                currentPlayer.playbackRate = parseFloat(event.target.value);
            }
        }
        function setPlaybackQuality(event) {
            if (currentHls) {
                currentHls.currentLevel = parseInt(event.target.value, 10);
            }
        }
        
        // MODIFIED: Toggle audio only with icon and title change
        function toggleAudioOnly() {
            const isActive = playerContainer.classList.toggle('audio-mode');
            audioOnlyBtn.classList.toggle('active', isActive);
            if (isActive) {
                audioOnlyBtn.innerHTML = '<i class="fas fa-video"></i>';
                audioOnlyBtn.title = 'Ù†Ù…Ø§ÛŒØ´ ØªØµÙˆÛŒØ±';
            } else {
                audioOnlyBtn.innerHTML = '<i class="fas fa-music"></i>';
                audioOnlyBtn.title = 'ÙÙ‚Ø· ØµØ¯Ø§';
            }
        }

        function shareChannel() {
            if (!currentChannelForModal) return;
            const shareUrl = `${window.location.origin}${window.location.pathname}?channel=${getChannelId(currentChannelForModal)}`;
            navigator.clipboard.writeText(shareUrl).then(() => showToast('Ù„ÛŒÙ†Ú© Ú©Ø§Ù†Ø§Ù„ Ú©Ù¾ÛŒ Ø´Ø¯!', 'success'), () => showToast('Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†Ú©', 'error'));
        }
        
        async function checkForSharedChannel() {
            const channelId = new URLSearchParams(window.location.search).get('channel');
            if (!channelId) return;
            await fetchAllChannels(countriesData, true); 
            const sharedChannel = allChannels.find(ch => getChannelId(ch) === channelId);
            if (sharedChannel) {
                playChannel(sharedChannel);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        async function fetchAllChannels(countries, forceWait = false) {
            if (allChannels.length > 0 && !forceWait) return;
            document.getElementById('allChannelsBtn').disabled = true;
            const promises = Object.keys(countries)
                .filter(code => countries[code].hasChannels)
                .map(code => fetch(`${COUNTRY_BASE_URL}${code.toLowerCase()}.json`).then(res => res.ok ? res.json() : []).catch(() => []));
            allChannels = (await Promise.all(promises)).flat();
            document.getElementById('allChannelsBtn').disabled = false;
        }
        
        // --- UTILITY & HELPER FUNCTIONS ---
        function toggleAccordion(type) {
            const btn = document.getElementById(`${type}AccordionBtn`);
            const content = document.getElementById(`${type}AccordionContent`);
            content.classList.toggle('hidden');
            btn.querySelector('i.fa-chevron-down').classList.toggle('rotate-180');
        }
        function loadFavorites() { favorites = JSON.parse(localStorage.getItem('tvFavorites') || '[]'); }
        function saveFavorites() { localStorage.setItem('tvFavorites', JSON.stringify(favorites)); }
        
        function selectFavorites() { lastSelected = {type:'favorites'}; document.getElementById('main-title').innerHTML = `<i class="fas fa-star mr-2" style="color: var(--favorite-color);"></i>Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§`; document.getElementById('main-subtitle').textContent = `Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø³ØªØ§Ø±Ù‡â€ŒØ¯Ø§Ø± Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯`; filterAndDisplay(); }
        async function selectRecordings() { lastSelected = {type:'recordings'}; document.getElementById('main-title').innerHTML = `<i class="fas fa-hdd mr-2"></i>ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ÛŒ Ø¶Ø¨Ø· Ø´Ø¯Ù‡`; document.getElementById('main-subtitle').textContent = `ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¶Ø¨Ø· Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯`; const recs = await getRecordings(); displayRecordings(recs); }
        function selectAllWindows() { lastSelected = {type:'all'}; document.getElementById('main-title').innerHTML = `<i class="fas fa-globe-europe mr-2"></i>Ù‡Ù…Ù‡â€ŒÛŒ Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§`; document.getElementById('main-subtitle').textContent = `Ù†Ù…Ø§ÛŒØ´ ØªÙ…Ø§Ù… Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯`; currentChannels = allChannels; filterAndDisplay(); }
        function selectCountry(code, data) { lastSelected = {type:'country', id:code}; document.getElementById('main-title').textContent = `Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ú©Ø´ÙˆØ± ${data.country_fa}`; document.getElementById('main-subtitle').innerHTML = `Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ ØªÙ„ÙˆÛŒØ²ÛŒÙˆÙ†ÛŒ Ø²Ù†Ø¯Ù‡ Ø§Ø² <img src="${FLAG_API_BASE}${FLAG_COUNTRY_MAPPINGS[code.toUpperCase()] || code.toLowerCase()}.png" class="w-5 h-4 inline-block mx-1 rounded-sm"> ${data.country}`; loadChannels(`${COUNTRY_BASE_URL}${code.toLowerCase()}.json`); }
        function selectCategory(id, name, icon) { lastSelected = {type:'category', id:id}; document.getElementById('main-title').innerHTML = `<i class="fas ${icon} mr-2"></i>Ù…ÙˆØ¶ÙˆØ¹: ${name}`; document.getElementById('main-subtitle').textContent = `Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø· Ø¨Ø§ ${name}`; loadChannels(`${CATEGORIES_BASE_URL}${id}.json`); }
        
        async function loadChannels(url) { showLoading(); try { const res = await fetch(url); currentChannels = await res.json(); filterAndDisplay(); } catch (e) { showError('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§.'); } }
        
        function filterAndDisplay() {
            if (lastSelected.type === 'recordings') return;
            let source = [];
            if (lastSelected.type === 'favorites') source = favorites;
            else if (lastSelected.type === 'all') source = allChannels;
            else source = currentChannels;
            
            const searchTerm = document.getElementById('channelSearch').value.toLowerCase();
            const activeSourceFilter = document.querySelector('#sourceFilters .filter-btn.active').dataset.filter;
            
            const filtered = source.filter(ch => 
                ch.name.toLowerCase().includes(searchTerm) && 
                (activeSourceFilter === 'all' || 
                (activeSourceFilter === 'iptv' && ch.iptv_urls.length) || 
                (activeSourceFilter === 'youtube' && ch.youtube_urls.length))
            );
            
            displayChannels(filtered);
            document.getElementById('channelCount').textContent = filtered.length;
            document.getElementById('resultsCount').classList.toggle('hidden', filtered.length === 0);
        }
        
        function toggleSourceFilter(filter) { document.querySelectorAll('#sourceFilters .filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.filter === filter)); filterAndDisplay(); }
        
        function populateCategoriesList() {
            const closeMenu = () => document.getElementById('closeMenuBtn').click();
            document.getElementById('categoriesAccordionContent').innerHTML = CATEGORIES.map(c => 
                `<a href="#" class="menu-item flex justify-between items-center gap-3 px-2 py-2 hover:bg-[var(--highlight-bg)] rounded-md" onclick="event.preventDefault(); selectCategory('${c.id}', '${c.name_fa}', '${c.icon}'); closeMenu()">
                    <div class="flex items-center gap-2"><i class="fas ${c.icon} w-5 text-center"></i><span class="font-normal text-xs">${c.name_fa}</span></div>
                    <span class="text-xs font-normal text-gray-400 uppercase" dir="ltr">${c.name_en}</span>
                </a>`
            ).join('');
        }
        
        function populateCountriesList(data) {
             const closeMenu = () => document.getElementById('closeMenuBtn').click();
             document.getElementById('countriesAccordionContent').innerHTML = Object.entries(data).filter(([_,d])=>d.hasChannels).sort((a,b)=>a[1].country_fa.localeCompare(b[1].country_fa,'fa')).map(([c,d])=>
                `<a href="#" class="menu-item flex justify-between items-center gap-3 px-2 py-2 hover:bg-[var(--highlight-bg)] rounded-md" onclick='event.preventDefault(); selectCountry("${c}", ${JSON.stringify(d).replace(/'/g, "\\'")}); closeMenu()'>
                    <div class="flex items-center gap-2">
                        <img src="${FLAG_API_BASE}${FLAG_COUNTRY_MAPPINGS[c.toUpperCase()] || c.toLowerCase()}.png" class="w-5 h-5 object-contain rounded-sm">
                        <span class="font-normal text-xs">${d.country_fa}</span>
                    </div>
                    <span class="text-xs font-normal text-gray-400 uppercase" dir="ltr">${d.country}</span>
                </a>`
            ).join('');
        }
        
        function showError(message) { channelGrid.innerHTML = `<div class="col-span-full text-center py-12"><i class="fas fa-exclamation-circle text-4xl text-red-500 mb-4"></i><p>${message}</p></div>`; }
        function toggleFullScreen() { const elem = playerModal; if (!document.fullscreenElement) { elem.requestFullscreen().catch(err => console.error(err)); } else { document.exitFullscreen(); } }
        
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { if(document.getElementById('sideMenu').classList.contains('open')) { document.getElementById('closeMenuBtn').click(); } else if (!playerModal.classList.contains('hidden')) { closePlayer(); } } });
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
